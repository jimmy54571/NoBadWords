<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> No Bad Words </title>
    <style>
        body {
            font-family: "Comic Sans MS", Arial, sans-serif;
            background: linear-gradient(135deg, #ffdde1, #ee9ca7);
            text-align: center;
            padding: 20px;
            color: #ff4081;
        }

        h1 {
            font-size: 32px;
            color: white;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
        }

        .container {
            display: flex;
            justify-content: center;
            gap: 50px;
            margin-top: 20px;
        }

        .section {
            width: 40%;
            padding: 20px;
            border-radius: 15px;
            background: #fff5f8;
            box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
        }

        .section:hover {
            transform: scale(1.02);
        }

        h2 {
            font-size: 24px;
            color: #ff4081;
        }

        p {
            font-size: 18px;
            margin: 10px 0;
            color: #333;
        }

        button {
            padding: 12px 18px;
            font-size: 16px;
            color: white;
            background: linear-gradient(135deg, #ff4081, #ff80ab);
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: background 0.3s, transform 0.2s;
            box-shadow: 3px 3px 8px rgba(0, 0, 0, 0.2);
        }

        button:hover {
            background: linear-gradient(135deg, #ff80ab, #ff4081);
            transform: scale(1.1);
        }

        .log {
            margin-top: 15px;
            text-align: left;
            font-size: 14px;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border-radius: 10px;
            padding: 10px;
            border: 2px solid #ff69b4;
        }

        .log p {
            font-size: 14px;
            margin: 5px 0;
            color: #555;
        }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC5xkI7FKP6fzbIg9LwAy7IXle6z4GnI-A",
            authDomain: "nobadword-87b1f.firebaseapp.com",
            projectId: "nobadword-87b1f",
            storageBucket: "nobadword-87b1f.firebasestorage.app",
            messagingSenderId: "604543524172",
            appId: "1:604543524172:web:06fdf372517480efd103e9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const INITIAL_WEEKLY_POINTS = { user: 5, girlfriend: 14 };

       async function getPoints(user) {
        const docRef = doc(db, "points", user);
        const docSnap = await getDoc(docRef);
    
        if (docSnap.exists()) {
            let data = docSnap.data();
            // 確保 logs 欄位存在
            if (!data.logs) data.logs = [];
            return data;
            } else {
            return { total: 0, weekly: INITIAL_WEEKLY_POINTS[user], logs: [] };
            }
        }


        async function updateUI() {
            const userData = await getPoints("user");
            const gfData = await getPoints("girlfriend");

            document.getElementById("userTotal").textContent = `Total: ${userData.total}`;
            document.getElementById("userWeekly").textContent = `Weekly Remaining: ${userData.weekly}`;

            document.getElementById("gfTotal").textContent = `Total: ${gfData.total}`;
            document.getElementById("gfWeekly").textContent = `Weekly Remaining: ${gfData.weekly}`;

            displayLogs("userLogs", userData.logs);
            displayLogs("gfLogs", gfData.logs);
        }

            function displayLogs(elementId, logs = []) {
            const logContainer = document.getElementById(elementId);
            logContainer.innerHTML = "";
    
            logs.slice().reverse().forEach(log => {
            const logEntry = document.createElement("p");
            logEntry.textContent = `[${log.timestamp}] ${log.reason}`;
            logContainer.appendChild(logEntry);
            });
        }


        async function deductPoint(user) {
    try {
        // 提示輸入扣分原因
        const reason = prompt(`Enter reason for ${user}'s deduction:`);
        if (!reason) {
            alert("No reason entered. Deduction canceled.");
            return;
        }

        // 獲取 Firestore 數據
        const docRef = doc(db, "points", user);
        let data = await getPoints(user);
        data.weekly = Math.max(0, data.weekly - 1); // 確保不會低於 0

        // 生成時間戳記
        const timestamp = new Date().toLocaleString();
        const logEntry = { timestamp, reason };

        // 更新 Firestore
        await setDoc(docRef, { ...data, logs: arrayUnion(logEntry) });

        // 更新 UI
        updateUI();
        alert(`Successfully deducted 1 point from ${user}.\nReason: ${reason}`);
    } catch (error) {
        console.error("Error deducting points:", error);
        alert("Error deducting points. Please check the console for details.");
    }
}


        async function resetWeeklyPoints() {
            const now = new Date();
            const lastReset = localStorage.getItem("lastReset") || "0";
            const currentWeek = getCurrentWeek();

            if (lastReset !== currentWeek) {
                await updateTotalPoints("user");
                await updateTotalPoints("girlfriend");
                localStorage.setItem("lastReset", currentWeek);
            }
        }

        async function updateTotalPoints(user) {
            const docRef = doc(db, "points", user);
            let data = await getPoints(user);
            data.total += data.weekly;
            data.weekly = INITIAL_WEEKLY_POINTS[user];

            await setDoc(docRef, data);
            updateUI();
        }

        function getCurrentWeek() {
            const now = new Date();
            const year = now.getFullYear();
            const startDate = new Date(year, 0, 1);
            const days = Math.floor((now - startDate) / (24 * 60 * 60 * 1000));
            const weekNumber = Math.ceil((days + startDate.getDay() + 1) / 7);
            return `${year}-W${weekNumber}`;
        }

        window.onload = async function () {
    await resetWeeklyPoints();
    await updateUI();

    // 確保事件綁定正確
    document.getElementById("deductUser").onclick = function () {
        deductPoint("user");
    };
    document.getElementById("deductGF").onclick = function () {
        deductPoint("girlfriend");
    };
};

    </script>
</head>
<body>
    <h1> No Bad Words ! </h1>
    
    <div class="container">
        <div class="section">
            <h2>Baby penguin</h2>
            <p id="userTotal">Total: 0</p>
            <p id="userWeekly">Weekly Remaining: 0</p>
            <button id="deductUser">Deduct 1 Point</button>
            <div id="userLogs" class="log"></div>
        </div>

        <div class="section">
            <h2>Bebe Celine</h2>
            <p id="gfTotal">Total: 0</p>
            <p id="gfWeekly">Weekly Remaining: 0</p>
            <button id="deductGF">Deduct 1 Point</button>
            <div id="gfLogs" class="log"></div>
        </div>
    </div>
</body>
</html>
